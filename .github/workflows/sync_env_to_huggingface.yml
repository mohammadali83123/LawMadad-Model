name: üîê Sync .env to Hugging Face Secrets

on:
  push:
    branches:
      - main  # or any branch you want

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install huggingface_hub python-dotenv requests

      - name: Sync .env to Hugging Face Space Secrets
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          DOTENV_CONTENT: ${{ secrets.DOTENV_CONTENT }}
        run: |
          python - <<'EOF'
          import os, requests
          from dotenv import dotenv_values

          HF_TOKEN = os.getenv("HF_TOKEN")
          DOTENV_CONTENT = os.getenv("DOTENV_CONTENT")
          SPACE_ID = "ali4568/LawMadad"  # change this

          # Parse .env contents
          lines = DOTENV_CONTENT.strip().splitlines()
          secrets = {}
          for line in lines:
              if line and not line.startswith("#") and "=" in line:
                  key, value = line.split("=", 1)
                  secrets[key.strip()] = value.strip()

          # Hugging Face API endpoint
          url = f"https://huggingface.co/api/spaces/{SPACE_ID}/secrets"
          headers = {"Authorization": f"Bearer {HF_TOKEN}"}

          for key, value in secrets.items():
              print(f"üîÅ Syncing {key} ...")
              payload = {"key": key, "value": value}
              resp = requests.post(url, headers=headers, json=payload)
              if resp.status_code in (200, 201):
                  print(f"‚úÖ {key} synced.")
              elif resp.status_code == 409:
                  print(f"üåÄ {key} already exists, updating...")
                  requests.put(f"{url}/{key}", headers=headers, json={"value": value})
              else:
                  print(f"‚ùå Failed to sync {key}: {resp.status_code} - {resp.text}")

          print("üéØ All .env variables synced to Hugging Face!")
          EOF